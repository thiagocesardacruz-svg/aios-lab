# Story 2.1: Business DNA Collection Flow

> **Epic:** 2 - Core App
> **Status:** READY
> **Priority:** P0
> **Estimate:** 4-5 hours
> **Depends on:** 1.3

---

## Objective

Implement the Business DNA collection flow that new users complete on first login. This is CRITICAL for the product - DNA enables personalized prompts.

**North Star:** Complete DNA setup in < 3 minutes on mobile.

---

## Acceptance Criteria

- [ ] DNA collection flow triggers for new users (no DNA record)
- [ ] 4 mandatory fields collected: business_name, location, target_audience, tone, primary_goal
- [ ] Mobile-friendly UI (step-by-step wizard)
- [ ] Progress indicator shows current step
- [ ] DNA saved to database on completion
- [ ] User redirected to dashboard after completion
- [ ] Existing users skip directly to dashboard

---

## Technical Notes

### 1. DNA Check Middleware

```typescript
// middleware.ts
import { NextResponse } from 'next/server';
import { createMiddlewareClient } from '@supabase/auth-helpers-nextjs';

export async function middleware(req: NextRequest) {
  const res = NextResponse.next();
  const supabase = createMiddlewareClient({ req, res });

  const { data: { session } } = await supabase.auth.getSession();

  // Not logged in - let auth handle it
  if (!session) return res;

  // Check if user has DNA
  const { data: dna } = await supabase
    .from('business_dna')
    .select('id')
    .eq('user_id', session.user.id)
    .single();

  // No DNA and not on onboarding page - redirect
  if (!dna && !req.nextUrl.pathname.startsWith('/onboarding')) {
    return NextResponse.redirect(new URL('/onboarding', req.url));
  }

  // Has DNA and on onboarding page - redirect to dashboard
  if (dna && req.nextUrl.pathname.startsWith('/onboarding')) {
    return NextResponse.redirect(new URL('/dashboard', req.url));
  }

  return res;
}

export const config = {
  matcher: ['/dashboard/:path*', '/library/:path*', '/trails/:path*', '/onboarding/:path*'],
};
```

### 2. Onboarding Page (Step Wizard)

```typescript
// app/onboarding/page.tsx
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { useAuth } from '@/lib/auth-context';
import { supabase } from '@/lib/supabase';

const STEPS = [
  {
    field: 'business_name',
    title: 'What is your business name?',
    placeholder: 'Hotel & Spa Belvedere',
    description: 'This will be used to personalize all your prompts',
  },
  {
    field: 'location',
    title: 'Where is your business located?',
    placeholder: 'Lisbon, Portugal',
    description: 'Location helps AI understand your market context',
  },
  {
    field: 'target_audience',
    title: 'Who is your target audience?',
    placeholder: 'Business travelers and couples seeking luxury experiences',
    description: 'This helps tailor communication style and offers',
  },
  {
    field: 'tone',
    title: 'What tone should your content have?',
    placeholder: 'Professional yet warm and welcoming',
    description: 'Your brand voice for all generated content',
  },
  {
    field: 'primary_goal',
    title: 'What is your primary goal right now?',
    placeholder: 'Increase direct bookings by 20%',
    description: 'This helps prioritize recommendations',
  },
];

export default function OnboardingPage() {
  const [currentStep, setCurrentStep] = useState(0);
  const [values, setValues] = useState<Record<string, string>>({});
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const { user } = useAuth();
  const router = useRouter();

  const step = STEPS[currentStep];
  const isLastStep = currentStep === STEPS.length - 1;
  const progress = ((currentStep + 1) / STEPS.length) * 100;

  const handleNext = async () => {
    const value = values[step.field]?.trim();

    if (!value) {
      setError('This field is required');
      return;
    }

    setError('');

    if (isLastStep) {
      await saveDNA();
    } else {
      setCurrentStep(currentStep + 1);
    }
  };

  const handleBack = () => {
    if (currentStep > 0) {
      setCurrentStep(currentStep - 1);
    }
  };

  const saveDNA = async () => {
    setLoading(true);
    try {
      const { error } = await supabase.from('business_dna').insert({
        user_id: user!.id,
        business_name: values.business_name,
        location: values.location,
        target_audience: values.target_audience,
        tone: values.tone,
        primary_goal: values.primary_goal,
      });

      if (error) throw error;

      router.push('/dashboard');
    } catch (err: any) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex flex-col items-center justify-center p-4">
      {/* Progress Bar */}
      <div className="w-full max-w-md mb-8">
        <div className="h-2 bg-gray-200 rounded-full">
          <div
            className="h-2 bg-blue-600 rounded-full transition-all"
            style={{ width: `${progress}%` }}
          />
        </div>
        <p className="text-sm text-gray-500 mt-2 text-center">
          Step {currentStep + 1} of {STEPS.length}
        </p>
      </div>

      {/* Step Content */}
      <div className="w-full max-w-md">
        <h1 className="text-2xl font-bold mb-2">{step.title}</h1>
        <p className="text-gray-600 mb-6">{step.description}</p>

        <input
          type="text"
          value={values[step.field] || ''}
          onChange={(e) => setValues({ ...values, [step.field]: e.target.value })}
          placeholder={step.placeholder}
          className="w-full p-4 border rounded-lg text-lg mb-4"
          autoFocus
          onKeyDown={(e) => e.key === 'Enter' && handleNext()}
        />

        {error && (
          <p className="text-red-600 mb-4">{error}</p>
        )}

        <div className="flex gap-4">
          {currentStep > 0 && (
            <button
              onClick={handleBack}
              className="flex-1 p-4 border rounded-lg hover:bg-gray-50"
            >
              Back
            </button>
          )}
          <button
            onClick={handleNext}
            disabled={loading}
            className="flex-1 p-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
          >
            {loading ? 'Saving...' : isLastStep ? 'Complete Setup' : 'Continue'}
          </button>
        </div>
      </div>

      {/* Skip for now - hidden but available */}
      <button
        onClick={() => router.push('/dashboard')}
        className="mt-8 text-gray-400 text-sm hover:text-gray-600"
      >
        Skip for now (prompts won't be personalized)
      </button>
    </div>
  );
}
```

### 3. DNA Hook for Easy Access

```typescript
// hooks/use-dna.ts
import { useEffect, useState } from 'react';
import { useAuth } from '@/lib/auth-context';
import { supabase } from '@/lib/supabase';

interface BusinessDNA {
  business_name: string;
  location: string;
  target_audience: string;
  tone: string;
  primary_goal: string;
  usp?: string;
  team_size?: string;
  current_tools?: string;
  challenges?: string;
}

export function useDNA() {
  const { user } = useAuth();
  const [dna, setDNA] = useState<BusinessDNA | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!user) {
      setLoading(false);
      return;
    }

    async function fetchDNA() {
      const { data, error } = await supabase
        .from('business_dna')
        .select('*')
        .eq('user_id', user.id)
        .single();

      if (!error && data) {
        setDNA(data);
      }
      setLoading(false);
    }

    fetchDNA();
  }, [user]);

  return { dna, loading, hasDNA: !!dna };
}
```

### 4. DNA Variable Substitution Function

```typescript
// lib/dna-substitute.ts
export function substituteDNA(template: string, dna: BusinessDNA): string {
  return template
    .replace(/\{\{business_name\}\}/g, dna.business_name)
    .replace(/\{\{location\}\}/g, dna.location)
    .replace(/\{\{target_audience\}\}/g, dna.target_audience)
    .replace(/\{\{tone\}\}/g, dna.tone)
    .replace(/\{\{primary_goal\}\}/g, dna.primary_goal)
    .replace(/\{\{usp\}\}/g, dna.usp || '[Your USP]')
    .replace(/\{\{team_size\}\}/g, dna.team_size || '[Team size]')
    .replace(/\{\{current_tools\}\}/g, dna.current_tools || '[Current tools]')
    .replace(/\{\{challenges\}\}/g, dna.challenges || '[Main challenges]');
}
```

---

## Files Changed

- `middleware.ts` (create/update)
- `app/onboarding/page.tsx` (create)
- `hooks/use-dna.ts` (create)
- `lib/dna-substitute.ts` (create)

---

## Definition of Done

- [ ] New user is redirected to onboarding
- [ ] All 5 steps complete on mobile in < 3 minutes
- [ ] DNA is saved correctly
- [ ] User redirected to dashboard after completion
- [ ] Existing users go directly to dashboard
- [ ] useDNA hook works throughout the app
