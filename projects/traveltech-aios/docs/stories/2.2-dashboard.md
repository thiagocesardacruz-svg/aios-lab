# Story 2.2: User Dashboard (My Products)

> **Epic:** 2 - Core App
> **Status:** READY
> **Priority:** P0
> **Estimate:** 4-5 hours
> **Depends on:** 1.2, 1.3, 2.1

---

## Objective

Create the main dashboard showing user's purchased products, active trails, and upgrade suggestions.

---

## Acceptance Criteria

- [ ] Dashboard shows all user's active products
- [ ] Each product card links to its content library
- [ ] "Add More Products" card links to store
- [ ] Active trail progress shown (if any)
- [ ] Upgrade suggestions shown (if user has standalone, suggest bundle)
- [ ] Welcome message with business name from DNA
- [ ] Mobile responsive

---

## Technical Notes

### 1. Fetch User Products Hook

```typescript
// hooks/use-user-products.ts
import { useEffect, useState } from 'react';
import { useAuth } from '@/lib/auth-context';
import { supabase } from '@/lib/supabase';

interface UserProduct {
  product_id: string;
  status: string;
  purchased_at: string;
  expires_at: string | null;
  trial_ends_at: string | null;
  product: {
    id: string;
    name: string;
    type: string;
    segment: string;
  };
}

export function useUserProducts() {
  const { user } = useAuth();
  const [products, setProducts] = useState<UserProduct[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!user) {
      setLoading(false);
      return;
    }

    async function fetchProducts() {
      const { data, error } = await supabase
        .from('user_products')
        .select(`
          product_id,
          status,
          purchased_at,
          expires_at,
          trial_ends_at,
          product:products(id, name, type, segment)
        `)
        .eq('user_id', user.id)
        .in('status', ['active', 'trial']);

      if (!error && data) {
        setProducts(data as UserProduct[]);
      }
      setLoading(false);
    }

    fetchProducts();
  }, [user]);

  const hasBundle = products.some(p => p.product?.type === 'bundle');
  const hasStandalone = products.some(p => p.product?.type === 'standalone');
  const canUpgrade = hasStandalone && !hasBundle;

  return { products, loading, hasBundle, hasStandalone, canUpgrade };
}
```

### 2. Dashboard Page

```typescript
// app/dashboard/page.tsx
'use client';

import { useDNA } from '@/hooks/use-dna';
import { useUserProducts } from '@/hooks/use-user-products';
import { ProductCard } from '@/components/product-card';
import { TrailProgress } from '@/components/trail-progress';
import { UpgradeBanner } from '@/components/upgrade-banner';
import Link from 'next/link';

export default function DashboardPage() {
  const { dna, loading: dnaLoading } = useDNA();
  const { products, loading: productsLoading, canUpgrade } = useUserProducts();

  if (dnaLoading || productsLoading) {
    return <DashboardSkeleton />;
  }

  return (
    <div className="container mx-auto px-4 py-8">
      {/* Welcome */}
      <h1 className="text-2xl font-bold mb-8">
        üëã Welcome back{dna?.business_name ? `, ${dna.business_name}` : ''}
      </h1>

      {/* My Products */}
      <section className="mb-8">
        <h2 className="text-lg font-semibold mb-4">üì¶ My Products</h2>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {products.map((item) => (
            <ProductCard
              key={item.product_id}
              product={item.product}
              status={item.status}
              expiresAt={item.expires_at}
              trialEndsAt={item.trial_ends_at}
            />
          ))}
          <AddProductCard />
        </div>
      </section>

      {/* Active Trail */}
      <section className="mb-8">
        <TrailProgress />
      </section>

      {/* Upgrade Banner */}
      {canUpgrade && (
        <UpgradeBanner
          currentProducts={products.map(p => p.product)}
        />
      )}
    </div>
  );
}

function AddProductCard() {
  return (
    <Link
      href="/store"
      className="border-2 border-dashed border-gray-300 rounded-lg p-6 flex flex-col items-center justify-center hover:border-blue-500 hover:bg-blue-50 transition"
    >
      <span className="text-4xl mb-2">‚ûï</span>
      <span className="font-medium">Add More Products</span>
      <span className="text-sm text-gray-500">Browse our store</span>
    </Link>
  );
}

function DashboardSkeleton() {
  return (
    <div className="container mx-auto px-4 py-8 animate-pulse">
      <div className="h-8 bg-gray-200 rounded w-64 mb-8" />
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {[1, 2, 3].map((i) => (
          <div key={i} className="h-40 bg-gray-200 rounded-lg" />
        ))}
      </div>
    </div>
  );
}
```

### 3. Product Card Component

```typescript
// components/product-card.tsx
import Link from 'next/link';

const PRODUCT_ICONS: Record<string, string> = {
  hotel: 'üè®',
  agency: '‚úàÔ∏è',
  dmc: 'üó∫Ô∏è',
  dmo: 'üèõÔ∏è',
  all: 'üîß',
};

interface ProductCardProps {
  product: {
    id: string;
    name: string;
    type: string;
    segment: string;
  };
  status: string;
  expiresAt: string | null;
  trialEndsAt: string | null;
}

export function ProductCard({ product, status, expiresAt, trialEndsAt }: ProductCardProps) {
  const icon = PRODUCT_ICONS[product.segment] || 'üì¶';
  const isTrial = status === 'trial';
  const daysLeft = trialEndsAt
    ? Math.ceil((new Date(trialEndsAt).getTime() - Date.now()) / (1000 * 60 * 60 * 24))
    : null;

  return (
    <Link
      href={`/library/${product.id}`}
      className="bg-white border rounded-lg p-6 hover:shadow-md transition"
    >
      <div className="text-4xl mb-3">{icon}</div>
      <h3 className="font-semibold text-lg">{product.name}</h3>
      <p className="text-sm text-gray-500 capitalize">{product.type}</p>

      {isTrial && daysLeft !== null && (
        <div className="mt-3 text-sm text-orange-600">
          ‚è±Ô∏è {daysLeft} days left in trial
        </div>
      )}

      <div className="mt-4 text-blue-600 text-sm font-medium">
        Open ‚Üí
      </div>
    </Link>
  );
}
```

### 4. Upgrade Banner Component

```typescript
// components/upgrade-banner.tsx
import Link from 'next/link';

interface UpgradeBannerProps {
  currentProducts: Array<{
    id: string;
    segment: string;
    type: string;
  }>;
}

export function UpgradeBanner({ currentProducts }: UpgradeBannerProps) {
  // Find which bundle to suggest based on current products
  const standalones = currentProducts.filter(p => p.type === 'standalone');
  const segments = [...new Set(standalones.map(p => p.segment))];
  const suggestedBundle = segments[0] ? `${segments[0]}-aios` : 'hotel-aios';

  const bundleNames: Record<string, string> = {
    'hotel-aios': 'Hotel AIOS',
    'agency-aios': 'Agency AIOS',
    'dmc-aios': 'DMC AIOS',
    'dmo-aios': 'DMO AIOS',
  };

  return (
    <div className="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-lg p-6">
      <div className="flex items-start justify-between">
        <div>
          <h3 className="font-semibold text-lg mb-1">üí° Upgrade Suggestion</h3>
          <p className="text-gray-600">
            You have standalone products. Get{' '}
            <strong>{bundleNames[suggestedBundle]}</strong> for full access to
            Prompts + Trails + SOPs + AI Tutor.
          </p>
          <p className="text-sm text-blue-600 mt-2">
            Save 40% compared to buying separately.
          </p>
        </div>
        <Link
          href={`/store/${suggestedBundle}`}
          className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 whitespace-nowrap"
        >
          See Offer ‚Üí
        </Link>
      </div>
    </div>
  );
}
```

---

## Files Changed

- `hooks/use-user-products.ts` (create)
- `app/dashboard/page.tsx` (create)
- `components/product-card.tsx` (create)
- `components/upgrade-banner.tsx` (create)
- `components/trail-progress.tsx` (create - stub for now)

---

## Definition of Done

- [ ] Dashboard shows user's products correctly
- [ ] Product cards link to library
- [ ] Add product card links to store
- [ ] Trial status shows correctly
- [ ] Upgrade banner appears for standalone users
- [ ] Mobile responsive
