# Story GOV-001.2: Handover Validator Skill

## Status
**Done**

---

## Community Origin
*N/A - Internal governance enhancement*

---

## Story

**As a** AIOS agent transferring work to another agent,
**I want** a skill that validates my handover contract,
**so that** I receive immediate feedback if my handover is incomplete or invalid.

---

## Acceptance Criteria

1. [x] Skill structure follows `/skill-creator` standard: `SKILL.md` + `scripts/` + `references/`
2. [x] Skill valida contratos contra JSON schema (de Story GOV-001.1)
3. [x] Skill verifica presença de `evidence` quando `confidence` < high
4. [x] Skill detecta campos faltantes e sugere correções específicas
5. [x] Skill integra com skill-auto-routing (`auto_invoke: true`)
6. [x] Skill bloqueia handover se validation fails (com mensagem clara)
7. [x] Skill registra validação em paper trail
8. [x] Skill oferece `--quick` mode para handovers simples (minimal validation)
9. [x] Skill listado em `.claude/skills/_registry.yaml`

---

## CodeRabbit Integration

### Story Type Analysis

**Primary Type**: Integration (Skill System)
**Secondary Type(s)**: API, Configuration
**Complexity**: Medium

### Specialized Agent Assignment

**Primary Agents**:
- @dev (skill implementation)
- @architect (design review)

**Supporting Agents**:
- @qa (integration testing)

### Quality Gate Tasks

- [ ] Pre-Commit (@dev): Skill structure validation, script syntax
- [ ] Pre-PR (@architect): Integration design review
- [ ] Pre-PR (@github-devops): Skill registry update validation

### Self-Healing Configuration

**Expected Self-Healing**:
- Primary Agent: @dev (light mode)
- Max Iterations: 2
- Timeout: 15 minutes
- Severity Filter: CRITICAL, HIGH

**Predicted Behavior**:
- CRITICAL issues: auto_fix (syntax errors, missing files)
- HIGH issues: document_only (design decisions)

### CodeRabbit Focus Areas

**Primary Focus**:
- Skill structure compliance
- Schema validation logic correctness
- Error message clarity

**Secondary Focus**:
- Auto-routing integration
- Quick mode implementation

---

## Tasks / Subtasks

- [ ] **Task 1: Create Skill Structure** (AC: 1, 9)
  - [ ] Create `.claude/skills/handover-validator/SKILL.md`
  - [ ] Create `.claude/skills/handover-validator/scripts/validate-handover.js`
  - [ ] Create `.claude/skills/handover-validator/references/five-trust-behaviors.md`
  - [ ] Add skill to `.claude/skills/_registry.yaml`

- [ ] **Task 2: Implement Validation Logic** (AC: 2, 3, 4)
  - [ ] Load JSON schema from `governance/schemas/handover-contract-schema.json`
  - [ ] Implement schema validation with ajv
  - [ ] Check `confidence` + `evidence` correlation
  - [ ] Generate specific error messages for each validation failure
  - [ ] Return structured validation result

- [ ] **Task 3: Implement Auto-Routing** (AC: 5, 6)
  - [ ] Add `auto_invoke: true` to SKILL.md frontmatter
  - [ ] Define triggers: keywords, patterns
  - [ ] Implement blocking behavior on validation failure
  - [ ] Return clear error message with fix suggestions

- [ ] **Task 4: Implement Quick Mode** (AC: 7, 8)
  - [ ] Add `--quick` flag support
  - [ ] Define minimal validation (from_agent, to_agent, artifact_type only)
  - [ ] Log quick mode usage in paper trail
  - [ ] Document when quick mode is appropriate

- [ ] **Task 5: Integration Testing**
  - [ ] Test with valid handover contract
  - [ ] Test with missing required fields
  - [ ] Test with invalid confidence/evidence combination
  - [ ] Test quick mode
  - [ ] Test auto-routing trigger

---

## Dev Notes

### Source Files to Create

```
.claude/skills/handover-validator/
├── SKILL.md                           # Skill definition with frontmatter
├── scripts/
│   └── validate-handover.js           # Validation logic
└── references/
    └── five-trust-behaviors.md        # Reference documentation
```

### Files to Update

```
.claude/skills/_registry.yaml          # Add handover-validator entry
```

### SKILL.md Frontmatter Template

```yaml
---
name: handover-validator
description: |
  Validates handover contracts between agents, ensuring complete context transfer
  and enforcement of Five Trust Behaviors.

auto_invoke: true
triggers:
  keywords:
    - "handover"
    - "transferir para"
    - "passar para @"
    - "delegate to"
  patterns:
    - "@[a-z-]+ recebe"
    - "handoff to @"
agents_allowed:
  - all
priority: high
confirm_before_invoke: false
---
```

### Validation Logic Pseudocode

```javascript
async function validateHandover(contract, options = {}) {
  const schema = loadSchema('governance/schemas/handover-contract-schema.json');
  const ajv = new Ajv({ allErrors: true });
  const validate = ajv.compile(schema);

  // Quick mode: minimal validation
  if (options.quick) {
    return validateQuick(contract);
  }

  // Full validation
  const valid = validate(contract);
  if (!valid) {
    return {
      valid: false,
      errors: formatErrors(validate.errors),
      suggestions: generateSuggestions(validate.errors)
    };
  }

  // Trust Behavior validation
  if (contract.verification.confidence !== 'high' && !contract.verification.evidence?.length) {
    return {
      valid: false,
      errors: ['Evidence required when confidence is not high'],
      suggestions: ['Add evidence array with at least one item']
    };
  }

  return { valid: true, contract };
}
```

### Dependencies

- **Story GOV-001.1**: Requires `handover-contract-schema.json` to exist
- **skill-auto-routing**: Must be registered in `_registry.yaml`

### Testing

- **Test location**: `.claude/skills/handover-validator/tests/`
- **Framework**: Node.js native test runner
- **Pattern**: Unit tests for validation logic

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-12 | 1.0 | Story created from Epic AIOS-GOV-001 | @sm (River) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (@dev - Dex)

### Debug Log References
- Tests: `node --test .claude/skills/handover-validator/tests/validate-handover.test.mjs` (22/22 passed)

### Completion Notes List
1. Created skill structure: SKILL.md + scripts/ + references/
2. Implemented full validation against JSON schema
3. Implemented Five Trust Behaviors enforcement (evidence when confidence < high)
4. Added --quick mode for minimal validation
5. Added auto_invoke: true with comprehensive triggers
6. Registered skill in _registry.yaml
7. All 22 tests passing across 5 test suites

### File List
- `.claude/skills/handover-validator/SKILL.md` (NEW)
- `.claude/skills/handover-validator/scripts/validate-handover.js` (NEW)
- `.claude/skills/handover-validator/references/five-trust-behaviors.md` (NEW)
- `.claude/skills/handover-validator/tests/validate-handover.test.mjs` (NEW)
- `.claude/skills/_registry.yaml` (UPDATED - added handover-validator entry)

---

## QA Results
*To be filled by @qa*
