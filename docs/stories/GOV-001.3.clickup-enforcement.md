# Story GOV-001.3: ClickUp Integration & Enforcement

## Status
**Done**

---

## Community Origin
*N/A - Internal governance enhancement*

---

## Story

**As a** AIOS administrator,
**I want** handover validation integrated with ClickUp status transitions,
**so that** tasks cannot be marked complete without valid handover contracts.

---

## Acceptance Criteria

1. [x] `clickup-sync.mjs` valida handover contract antes do comando `done`
2. [x] Transição bloqueada se contrato inválido (com mensagem de erro clara)
3. [x] Paper trail automático: comentário ClickUp criado com resumo do contrato
4. [x] Flag `--skip-handover` disponível para casos excepcionais (com log de justificativa)
5. [x] Script `handover-gate.mjs` criado para validação standalone
6. [x] `.claude/rules/clickup-auto-sync.md` atualizado com regras de handover
7. [x] Graceful degradation: se schema não existe, warn mas não bloqueia
8. [x] Métricas: contador de handovers válidos vs inválidos

---

## CodeRabbit Integration

### Story Type Analysis

**Primary Type**: Integration (ClickUp API)
**Secondary Type(s)**: API, Configuration
**Complexity**: Medium-High

### Specialized Agent Assignment

**Primary Agents**:
- @dev (script implementation)
- @devops (ClickUp API integration)

**Supporting Agents**:
- @qa (integration testing with ClickUp sandbox)

### Quality Gate Tasks

- [ ] Pre-Commit (@dev): Script syntax, error handling validation
- [ ] Pre-PR (@devops): ClickUp API integration review
- [ ] Pre-PR (@github-devops): Integration test results

### Self-Healing Configuration

**Expected Self-Healing**:
- Primary Agent: @dev (light mode)
- Max Iterations: 2
- Timeout: 15 minutes
- Severity Filter: CRITICAL, HIGH

**Predicted Behavior**:
- CRITICAL issues: auto_fix (syntax errors, API errors)
- HIGH issues: document_only (integration decisions)

### CodeRabbit Focus Areas

**Primary Focus**:
- ClickUp API error handling
- Graceful degradation logic
- Security (no credentials in code)

**Secondary Focus**:
- User experience (clear error messages)
- Logging completeness

---

## Tasks / Subtasks

- [ ] **Task 1: Update clickup-sync.mjs** (AC: 1, 2, 7)
  - [ ] Import handover validation from `/handover-validator` skill
  - [ ] Add validation check before `done` command
  - [ ] Return clear error message if validation fails
  - [ ] Implement graceful degradation (warn if schema missing)
  - [ ] Update help text with handover requirements

- [ ] **Task 2: Create handover-gate.mjs** (AC: 5)
  - [ ] Create `squads/ops/scripts/handover-gate.mjs`
  - [ ] Accept contract JSON as input
  - [ ] Call handover-validator skill
  - [ ] Return structured validation result
  - [ ] Support `--verbose` flag for detailed output

- [ ] **Task 3: Implement Paper Trail** (AC: 3, 8)
  - [ ] Create ClickUp comment on successful handover
  - [ ] Include contract summary in comment
  - [ ] Include from_agent, to_agent, artifact_type
  - [ ] Include confidence level and evidence count
  - [ ] Track metrics: valid vs invalid handovers

- [ ] **Task 4: Implement Skip Flag** (AC: 4)
  - [ ] Add `--skip-handover` flag to `done` command
  - [ ] Require `--reason` when skipping
  - [ ] Log skip to file and ClickUp comment
  - [ ] Emit warning to user about skipping

- [ ] **Task 5: Update Documentation** (AC: 6)
  - [ ] Update `.claude/rules/clickup-auto-sync.md`
  - [ ] Add handover validation section
  - [ ] Document skip flag usage
  - [ ] Add examples of valid handover flow

- [ ] **Task 6: Integration Testing**
  - [ ] Test `done` with valid handover contract
  - [ ] Test `done` with invalid contract (blocked)
  - [ ] Test `done --skip-handover --reason "emergency"`
  - [ ] Test paper trail comment creation
  - [ ] Test graceful degradation (missing schema)

---

## Dev Notes

### Source Files to Modify

```
squads/ops/scripts/clickup-sync.mjs     # UPDATE - add handover validation
squads/ops/scripts/handover-gate.mjs    # NEW - standalone validation
.claude/rules/clickup-auto-sync.md      # UPDATE - add handover rules
```

### Current clickup-sync.mjs Commands

Reference existing command structure:
- `create` - Create task
- `start` - Mark in progress
- `done` - Mark complete ← ADD HANDOVER VALIDATION HERE
- `await-human` - Mark waiting
- `comment` - Add comment

### Integration Flow

```
┌─────────────────────────────────────────────────────────────┐
│                  clickup-sync.mjs done                      │
│                                                             │
│  1. Parse command arguments                                 │
│  2. Check if handover validation enabled (config)           │
│  3. If enabled:                                             │
│     a. Look for handover contract in current context        │
│     b. Call handover-gate.mjs to validate                   │
│     c. If invalid: BLOCK with error message                 │
│     d. If valid: proceed to step 4                          │
│  4. Update ClickUp task status to "done"                    │
│  5. Create paper trail comment                              │
│  6. Return success                                          │
└─────────────────────────────────────────────────────────────┘
```

### Skip Handover Flow

```javascript
// Usage: node clickup-sync.mjs done <task_id> --skip-handover --reason "Emergency hotfix"

if (options.skipHandover) {
  if (!options.reason) {
    throw new Error('--reason required when using --skip-handover');
  }

  // Log the skip
  logHandoverSkip(taskId, options.reason);

  // Add ClickUp comment noting the skip
  await addComment(taskId, `⚠️ Handover validation skipped. Reason: ${options.reason}`);

  console.warn('⚠️ Handover validation skipped. This is logged for audit.');
}
```

### Paper Trail Comment Template

```markdown
## Handover Contract Validated

**From**: @pm (Morgan)
**To**: @sm (River)
**Artifact**: Epic AIOS-GOV-001
**Confidence**: High
**Evidence**: 3 items

**Next Actions**:
1. @sm: Create detailed stories
2. @architect: Review schema design

*Validated at: 2026-02-12T14:30:00Z*
```

### Dependencies

- **Story GOV-001.1**: Schema must exist for validation
- **Story GOV-001.2**: Skill must be functional
- **ClickUp API**: Requires `CLICKUP_API_TOKEN` in environment

### Testing

- **Test location**: `squads/ops/scripts/__tests__/`
- **Framework**: Jest or native Node.js test
- **Environment**: Use ClickUp sandbox/test workspace

### Configuration

Add to `core-config.yaml`:
```yaml
handover_validation:
  enabled: true
  mode: "warn"  # warn | block
  skip_allowed: true
  log_path: ".aios/logs/handover-skips.log"
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-12 | 1.0 | Story created from Epic AIOS-GOV-001 | @sm (River) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (@dev - Dex)

### Debug Log References
- `node squads/ops/scripts/handover-gate.mjs --help` - Help works
- `node squads/ops/scripts/handover-gate.mjs --validate-inline` - Validation works
- `node squads/ops/scripts/handover-gate.mjs --metrics` - Metrics tracking works
- Invalid contracts return exit code 1 with clear error messages

### Completion Notes List
1. Created `handover-gate.mjs` standalone validation script
2. Updated `clickup-sync.mjs` with handover validation on `done` command
3. Added `--handover`, `--skip-handover`, `--reason` flags
4. Implemented paper trail comment generation
5. Added metrics tracking (valid/invalid/skipped counts)
6. Updated `clickup-auto-sync.md` with comprehensive handover documentation
7. Graceful degradation when schema/script unavailable
8. All validation logic tested and working

### File List
- `squads/ops/scripts/handover-gate.mjs` (NEW)
- `squads/ops/scripts/clickup-sync.mjs` (UPDATED)
- `.claude/rules/clickup-auto-sync.md` (UPDATED)
- `.aios/logs/handover-metrics.json` (NEW - auto-generated)
- `.aios/logs/handover-skips.log` (NEW - auto-generated on skip)

---

## QA Results
*To be filled by @qa*
