# Story GOV-001.1: Handover Contract Schema & Governance Rules

## Status
**Done**

---

## Community Origin
*N/A - Internal governance enhancement*

---

## Story

**As a** AIOS agent executing workflows,
**I want** a well-defined schema for handover contracts,
**so that** I can transfer context to other agents with guaranteed completeness and traceability.

---

## Acceptance Criteria

1. [x] Schema JSON define campos obrigatórios: `from_agent`, `to_agent`, `artifact_type`, `required_fields`
2. [x] Schema inclui `verification` block com: `checklist_completed`, `checklist_path`, `confidence`, `evidence`
3. [x] Schema inclui `paper_trail` block com: `clickup_task_id`, `git_commit`, `timestamp`
4. [x] Schema inclui `next_actions` array para próximos passos explícitos
5. [x] Rules file `.claude/rules/handover-contracts.md` documenta quando handover é required
6. [x] Template `squads/_template/squad.yaml` atualizado com seção `handover_contracts`
7. [x] Backward compatibility: squads sem `handover_contracts` continuam funcionando
8. [x] Schema validado com ajv ou similar

---

## CodeRabbit Integration

### Story Type Analysis

**Primary Type**: Architecture
**Secondary Type(s)**: Configuration, Governance
**Complexity**: Medium

### Specialized Agent Assignment

**Primary Agents**:
- @architect (schema design, governance rules)
- @dev (JSON schema implementation)

**Supporting Agents**:
- @qa (schema validation testing)

### Quality Gate Tasks

- [ ] Pre-Commit (@dev): Schema syntax validation, YAML lint
- [ ] Pre-PR (@architect): Architecture review do schema
- [ ] Pre-PR (@github-devops): File structure validation

### Self-Healing Configuration

**Expected Self-Healing**:
- Primary Agent: @dev (light mode)
- Max Iterations: 2
- Timeout: 15 minutes
- Severity Filter: CRITICAL, HIGH

**Predicted Behavior**:
- CRITICAL issues: auto_fix (schema syntax errors)
- HIGH issues: document_only (design decisions)

### CodeRabbit Focus Areas

**Primary Focus**:
- JSON Schema syntax validity
- Required fields completeness
- Backward compatibility

**Secondary Focus**:
- Documentation clarity
- Example completeness

---

## Tasks / Subtasks

- [ ] **Task 1: Create JSON Schema** (AC: 1, 2, 3, 4)
  - [ ] Create `governance/schemas/handover-contract-schema.json`
  - [ ] Define `from_agent` and `to_agent` as required string fields
  - [ ] Define `artifact_type` enum: epic, story, task, document
  - [ ] Define `required_fields` as array of strings
  - [ ] Define `verification` object with nested fields
  - [ ] Define `paper_trail` object with nested fields
  - [ ] Define `next_actions` as array of strings
  - [ ] Add `$schema` reference and metadata

- [ ] **Task 2: Create Governance Rules** (AC: 5)
  - [ ] Create `.claude/rules/handover-contracts.md`
  - [ ] Document when handover contracts are REQUIRED
  - [ ] Document when handover contracts are OPTIONAL
  - [ ] Document Five Trust Behaviors mapping
  - [ ] Include examples of valid contracts

- [ ] **Task 3: Update Squad Template** (AC: 6, 7)
  - [ ] Edit `squads/_template/squad.yaml`
  - [ ] Add `handover_contracts` section with example
  - [ ] Ensure existing fields remain unchanged
  - [ ] Test that old squads load without errors

- [ ] **Task 4: Validation Testing** (AC: 8)
  - [ ] Write schema validation tests
  - [ ] Test with valid contract examples
  - [ ] Test with invalid contracts (missing fields)
  - [ ] Test backward compatibility

---

## Dev Notes

### Source Files to Modify

```
governance/schemas/handover-contract-schema.json (NEW)
.claude/rules/handover-contracts.md (NEW)
squads/_template/squad.yaml (UPDATE - add handover_contracts section)
```

### Reference: Five Trust Behaviors

| Behavior | Schema Field |
|----------|-------------|
| Verification Before Claim | `verification.evidence` |
| Loud Failure | Validation errors surfaced |
| Honest Uncertainty | `verification.confidence` |
| Paper Trail | `paper_trail.*` |
| Diligent Execution | `verification.checklist_completed` |

### Schema Example

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Handover Contract",
  "type": "object",
  "required": ["from_agent", "to_agent", "artifact_type", "verification", "paper_trail"],
  "properties": {
    "from_agent": { "type": "string", "pattern": "^@[a-z-]+$" },
    "to_agent": { "type": "string", "pattern": "^@[a-z-]+$" },
    "artifact_type": { "enum": ["epic", "story", "task", "document", "review"] },
    "required_fields": { "type": "array", "items": { "type": "string" } },
    "verification": {
      "type": "object",
      "required": ["checklist_completed", "confidence"],
      "properties": {
        "checklist_completed": { "type": "boolean" },
        "checklist_path": { "type": "string" },
        "confidence": { "enum": ["low", "medium", "high"] },
        "evidence": { "type": "array", "items": { "type": "string" } }
      }
    },
    "paper_trail": {
      "type": "object",
      "properties": {
        "clickup_task_id": { "type": "string" },
        "git_commit": { "type": "string" },
        "timestamp": { "type": "string", "format": "date-time" }
      }
    },
    "next_actions": { "type": "array", "items": { "type": "string" } }
  }
}
```

### Testing

- **Test location**: `tests/governance/handover-contract.test.js`
- **Framework**: Jest or native Node.js test runner
- **Pattern**: Schema validation with ajv

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-02-12 | 1.0 | Story created from Epic AIOS-GOV-001 | @sm (River) |

---

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (@architect - Aria)

### Debug Log References
- Tests: `node --test tests/governance/handover-contract.test.mjs` (12/12 passed)

### Completion Notes List
1. Created JSON Schema with all Five Trust Behaviors mapped
2. Added conditional validation: evidence required when confidence < high
3. Included comprehensive examples in schema
4. Created governance rules with clear REQUIRED/OPTIONAL guidelines
5. Updated squad template with handover_contracts section
6. All 12 validation tests passing

### File List
- `governance/schemas/handover-contract-schema.json` (NEW)
- `.claude/rules/handover-contracts.md` (NEW)
- `squads/_template/squad.yaml` (UPDATED)
- `tests/governance/handover-contract.test.mjs` (NEW)

---

## QA Results
*To be filled by @qa*
