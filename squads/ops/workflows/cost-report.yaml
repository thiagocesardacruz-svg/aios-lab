# /ops/cost-report Workflow
# Gera relatÃ³rio de custos

workflow:
  id: cost-report
  name: Cost Report
  description: "Consolida custos por squad, workflow, projeto e perÃ­odo"
  version: "1.0.0"
  squad: ops
  responsible: "@ops-lead"

inputs:
  - name: period
    type: string
    default: "month"
    options: [day, week, month]
  - name: breakdown
    type: string
    default: "squad"
    options: [squad, workflow, project, category]

outputs:
  - name: cost-report
    type: markdown
    path: "logs/reports/cost-{period}-{date}.md"

phases:
  - phase_0: Collect
  - phase_1: Calculate
  - phase_2: Compare
  - phase_3: Report

sequence:
  - phase: 0
    name: Collect Cost Logs
    agent: clawdbot
    action: read_files
    inputs:
      - path: "logs/costs/*.yaml"
      - path: "logs/service-orders/*.yaml"
    creates:
      - raw_data (memory)

  - phase: 1
    name: Calculate Totals
    agent: clawdbot
    action: calculate
    inputs:
      - raw_data
      - breakdown
    creates:
      - totals (memory)
    notes: |
      Por squad:
        - Total tokens in/out
        - Total EUR
        - MÃ©dia por OS
      Por workflow:
        - ExecuÃ§Ãµes
        - Custo mÃ©dio
        - Custo total
      Por categoria:
        - BASE, EXEC, VRFY, RCVR, DEV

  - phase: 2
    name: Compare with Budget
    agent: ops-manager
    action: compare
    inputs:
      - totals
      - budget: 470  # EUR mensal
    creates:
      - comparison (memory)
    notes: |
      - % do budget usado
      - ProjeÃ§Ã£o para fim do perÃ­odo
      - Alertas se > 80%

  - phase: 3
    name: Generate Report
    agent: ops-lead
    action: report
    inputs:
      - totals
      - comparison
    creates:
      - cost-report.md

output_format: |
  ## ğŸ’° Cost Report - {period}

  ### Summary
  - Total: â‚¬{total_eur}
  - Budget: â‚¬{budget_eur}
  - Used: {percent_used}%
  - Remaining: â‚¬{remaining}

  ### By {breakdown}
  {breakdown_table}

  ### Top Consumers
  {top_5_list}

  ### Alerts
  {alerts}

  ### Recommendations
  {recommendations}

alerts:
  - condition: "percent_used > 80"
    message: "âš ï¸ Budget above 80%"
    action: notify_director
  - condition: "daily_avg > 20"
    message: "ğŸ”´ Daily average exceeds limit"
    action: activate_safe_mode
